# Microsoft Defender Advanced Threat Protection Log Format
# Custom format for Microsoft Defender ATP/EDR logs

name: "microsoft_defender_atp"
pattern: ""
pattern_type: "json"

field_mappings:
  Timestamp: "timestamp"
  DeviceId: "host.id"
  DeviceName: "host.name"
  ActionType: "event.action"
  FileName: "file.name"
  FilePath: "file.path"
  SHA1: "file.hash.sha1"
  SHA256: "file.hash.sha256"
  MD5: "file.hash.md5"
  ProcessId: "process.pid"
  ProcessCommandLine: "process.command_line"
  ProcessParentId: "process.parent.pid"
  ProcessCreationTime: "process.start"
  AccountDomain: "user.domain"
  AccountName: "user.name"
  AccountSid: "user.id"
  LogonId: "user.session.id"
  InitiatingProcessAccountDomain: "process.parent.user.domain"
  InitiatingProcessAccountName: "process.parent.user.name"
  InitiatingProcessAccountSid: "process.parent.user.id"
  InitiatingProcessCommandLine: "process.parent.command_line"
  InitiatingProcessCreationTime: "process.parent.start"
  InitiatingProcessFileName: "process.parent.name"
  InitiatingProcessFolderPath: "process.parent.executable"
  InitiatingProcessId: "process.parent.pid"
  InitiatingProcessParentFileName: "process.ancestor.name"
  InitiatingProcessParentId: "process.ancestor.pid"
  InitiatingProcessSHA1: "process.parent.hash.sha1"
  InitiatingProcessSHA256: "process.parent.hash.sha256"
  InitiatingProcessMD5: "process.parent.hash.md5"
  LocalIP: "source.ip"
  LocalPort: "source.port"
  RemoteIP: "destination.ip"
  RemotePort: "destination.port"
  RemoteUrl: "url.original"
  RequestProtocol: "network.protocol"
  RegistryKey: "registry.key"
  RegistryValueName: "registry.value"
  RegistryValueData: "registry.data.strings"
  AdditionalFields: "event.additional_fields"
  MachineGroup: "host.group"
  ReportId: "event.id"
  AppGuardContainerId: "container.id"
  ThreatFamily: "threat.technique.name"
  ThreatName: "malware.name"
  DetectionSource: "event.provider"
  Severity: "event.severity"
  Category: "event.category"
  IsRootSignerMicrosoft: "code_signature.valid"
  SignerHash: "code_signature.subject_name"
  IsCertificateChainValid: "code_signature.trusted"
  IsExecutable: "file.executable"
  IsSigned: "code_signature.exists"

timestamp_field: "Timestamp"
timestamp_format: "iso8601"
severity_field: "Severity"
message_field: "ActionType"
source_field: "DeviceName"

preprocessing_rules:
  - "parse_additional_fields"
  - "normalize_paths"
  - "extract_process_tree"

validation_rules:
  - "require_device_name"
  - "require_action_type"
  - "validate_timestamp"
  - "validate_process_ids"

enabled: true
priority: 40

tags:
  - "microsoft"
  - "defender"
  - "atp"
  - "edr"
  - "endpoint"
  - "threat_detection"
  - "windows"